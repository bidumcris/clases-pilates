<div class="dashboard">
  <div class="dashboard-header">
    <%= image_tag "energia-pilates/1. logotipo/EP_logotipo 1.png", alt: "Energía Pilates", class: "dashboard-logo" %>
    <div class="dashboard-welcome">
      <div class="dashboard-classes-fixed">
        <div class="dashboard-kicker">TUS CLASES FIJAS SON:</div>
        <div class="dashboard-fixed-summary">
          <%= current_user.fixed_days_compact_summary.presence || "Aún no tenés clases fijas asignadas" %>
        </div>
      </div>
      <div class="dashboard-level-row">
        <span class="dashboard-level-label">Nivel</span>
        <span class="dashboard-level-value"><%= current_user.level.to_s.upcase %></span>
      </div>
      <div class="dashboard-payment-row">
        <span class="dashboard-payment-label">Pago:</span>
        <span class="payment-status-badge payment-status-badge--<%= current_user.billing_status %>">
          <%= current_user.billing_status.to_s.humanize %>
        </span>
      </div>
    </div>
  </div>

  <!-- Cuota / Suscripción del mes -->
  <% due_date_default = Date.current.change(day: 10) %>
  <% fee = @current_subscription_fee %>
  <% if current_user.payment_amount.present? %>
    <div class="card">
      <div class="card-header">Tu cuota</div>
      <% due_date = fee&.due_date || due_date_default %>
      <% status = fee&.payment_status || "pending" %>
      <% amount = fee&.amount || current_user.payment_amount %>
      <p>
        Vence el <strong><%= due_date.strftime("%d/%m/%Y") %></strong> ·
        Monto <strong><%= number_to_currency(amount, unit: "$", separator: ",", delimiter: ".") %></strong>
        <% if current_user.monthly_turns.present? %>
          · Plan: <strong><%= current_user.monthly_turns %> turnos/mes</strong>
        <% end %>
      </p>

      <% if fee.present? && fee.completed? %>
        <p><strong>Estado:</strong> al día ✅</p>
      <% elsif due_date < Date.current %>
        <p><strong>Estado:</strong> vencida ⚠️</p>
      <% elsif due_date == Date.current %>
        <p><strong>Estado:</strong> vence hoy ⚠️</p>
      <% elsif due_date == Date.current + 1.day %>
        <p><strong>Estado:</strong> vence mañana ⚠️</p>
      <% else %>
        <p><strong>Estado:</strong> pendiente</p>
      <% end %>

      <% if fee&.checkout_url.present? %>
        <%= link_to "Pagar ahora", fee.checkout_url, target: "_blank", rel: "noopener", class: "btn btn-primary" %>
      <% else %>
        <p style="opacity:0.8;">Si necesitás link de pago, pedilo en el estudio.</p>
      <% end %>
    </div>
  <% end %>

  <!-- Recuperos (Urgente - se vencen) -->
  <% expiring_credits = @credits.select { |c| c.expires_at && c.expires_at <= 7.days.from_now && c.amount > 0 } %>
  <% next_expiration = @credits.select { |c| c.expires_at && c.amount > 0 }.map(&:expires_at).compact.min %>
  <% if @credits.any? %>
    <div class="card credits-alert">
      <div class="card-header credits-header">
        <span>Recuperos disponibles</span>
        <% if expiring_credits.any? %>
          <span class="expiring-badge">Vencen pronto</span>
        <% end %>
      </div>
      <div class="credits-summary">
        <div class="credits-total">
          <span class="credits-number"><%= @credits.sum(&:amount) %></span>
          <span class="credits-label">recuperos disponibles</span>
          <% if next_expiration %>
            <p class="expiration-warning">
              ⚠️ <strong>¡Úsalos antes que se venzan!</strong> Los recuperos vencen el <strong><%= I18n.l(next_expiration, format: :long) %></strong>
            </p>
            <p class="expiration-cta">
              Reservá tu clase ahora antes que se venzan al final del mes
            </p>
          <% end %>
        </div>
        <% if expiring_credits.any? %>
          <div class="credits-expiring">
            <strong><%= expiring_credits.sum(&:amount) %> recuperos vencen en los próximos 7 días</strong>
            <ul class="expiring-list">
              <% expiring_credits.each do |credit| %>
                <li>
                  <%= credit.amount %> recuperos -
                  Vence: <%= credit.expires_at.strftime("%d/%m/%Y") %>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
        <div class="credits-actions">
          <%= link_to "Ver Agenda y Reservar", agenda_path, class: "btn btn-primary btn-large" %>
          <%= link_to "Ver todos los recuperos", creditos_path, class: "btn btn-outline-white" %>
        </div>
      </div>
    </div>
  <% end %>
  
  <div class="dashboard-grid">
    <!-- Próximas Clases -->
    <div class="card">
      <div class="card-header">Próximas Clases</div>
      <% if @fixed_classes_month.present? %>
        <ul class="reservations-list">
          <% @fixed_classes_month.each do |klass| %>
            <li class="reservation-item">
              <div>
                <strong><%= klass.name %></strong>
                <p class="reservation-details">
                  <%= klass.start_time.strftime("%d/%m/%Y %H:%M") %> -
                  <%= klass.room.name %>
                </p>
              </div>
            </li>
          <% end %>
        </ul>
        <%= link_to "Ver más", mi_actividad_path(date: Date.current.strftime("%Y-%m")), class: "btn btn-outline" %>
      <% elsif @reservations.any? %>
        <ul class="reservations-list">
          <% @reservations.limit(5).each do |reservation| %>
            <li class="reservation-item">
              <div>
                <strong><%= reservation.pilates_class.name %></strong>
                <p class="reservation-details">
                  <%= reservation.pilates_class.start_time.strftime("%d/%m/%Y %H:%M") %> - 
                  <%= reservation.pilates_class.room.name %>
                </p>
              </div>
            </li>
          <% end %>
        </ul>
        <%= link_to "Ver más", mi_actividad_path, class: "btn btn-outline" %>
      <% else %>
        <p>No tienes reservas próximas</p>
        <%= link_to "Ver Agenda", agenda_path, class: "btn btn-primary" %>
      <% end %>
    </div>

    <!-- Turnos Fijos (solo para usuarios grupales) -->
    <% if current_user.grupal? && current_user.fixed_slots.active.any? %>
      <div class="card">
        <div class="card-header">Turnos Fijos</div>
        <ul class="fixed-slots-list">
          <% current_user.fixed_slots.active.each do |slot| %>
            <li>
              <strong><%= slot.day_name %></strong> a las <strong><%= slot.time_string %></strong>
              <p class="slot-details"><%= slot.room.name %> - <%= slot.instructor.name %></p>
            </li>
          <% end %>
        </ul>
      </div>
    <% end %>

    <!-- Recuperos -->
    <div class="card">
      <div class="card-header">Recuperos</div>
      <p>
        Tenés <strong><%= @recoveries_this_month_total.to_i %></strong> recuperos disponibles este mes.
        <span style="opacity:.8;">(máximo <%= @recoveries_monthly_cap %> por mes)</span>
      </p>
      <div style="display:flex; gap:.5rem; flex-wrap: wrap;">
        <%= link_to "Ver Agenda", agenda_path, class: "btn btn-primary" %>
        <%= link_to "Ver recuperos", creditos_path, class: "btn btn-outline" %>
      </div>
    </div>
  </div>

</div>
