<div class="agenda-page">
  <h1>Ver Agenda</h1>

  <!-- Filtros -->
  <div class="calendar-filters">
    <%= form_with url: agenda_path, method: :get, local: true, data: { turbo_frame: "calendar" } do |f| %>
      <%= f.select :room_id, options_from_collection_for_select(@rooms, :id, :name, @room_filter), 
          { prompt: "Todas las salas" }, { class: "form-select" } %>
      <%= f.date_field :date, value: @date, class: "form-input" %>
      <%= f.submit "Filtrar", class: "btn btn-primary" %>
    <% end %>
  </div>

  <!-- Calendario con Turbo Frame -->
  <%= turbo_frame_tag "calendar" do %>
    <div class="calendar-container">
      <h2>Clases del <%= @date.strftime("%d/%m/%Y") %></h2>
      
      <% if @classes_by_hour.any? %>
        <% (7..21).each do |hour| %>
          <% classes_at_hour = @classes_by_hour[hour] || [] %>
          <div class="calendar-hour">
            <div class="calendar-hour-header">
              <span><%= hour %>:00</span>
              <% if classes_at_hour.any? %>
                <span><%= classes_at_hour.count %> clase(s)</span>
              <% end %>
            </div>
            
            <% if classes_at_hour.any? %>
              <% classes_at_hour.each do |pilates_class| %>
                <div class="class-item <%= 'full' if pilates_class.full? %>">
                  <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div>
                      <strong><%= pilates_class.name %></strong>
                      <p style="margin: 0.25rem 0; font-size: 0.875rem;">
                        <%= pilates_class.room.name %> - 
                        <%= pilates_class.instructor.name %> - 
                        Nivel: <%= pilates_class.level %>
                      </p>
                      <p style="margin: 0.25rem 0; font-size: 0.875rem;">
                        <%= pilates_class.start_time.strftime("%H:%M") %> - 
                        <%= pilates_class.end_time.strftime("%H:%M") %>
                      </p>
                    </div>
                    <div style="text-align: right;">
                      <% availability_class = case pilates_class.availability_percentage
                           when 0..25 then 'availability-low'
                           when 26..50 then 'availability-medium'
                           else 'availability-high'
                         end %>
                      <span class="availability-badge <%= availability_class %>">
                        <%= pilates_class.availability_percentage %>%
                      </span>
                      <p style="font-size: 0.75rem; margin-top: 0.25rem;">
                        <%= pilates_class.available_spots %>/<%= pilates_class.max_capacity %>
                      </p>
                    </div>
                  </div>
                  
                  <% if current_user.can_reserve_class?(pilates_class) && !pilates_class.full? %>
                    <%= button_to "Reservar", reservations_path, 
                        params: { pilates_class_id: pilates_class.id },
                        method: :post,
                        class: "btn btn-success",
                        style: "margin-top: 0.5rem;",
                        data: { turbo_frame: "_top" } %>
                  <% elsif pilates_class.full? %>
                    <%= button_to "Notificarme cuando se libere", requests_path, 
                        params: { pilates_class_id: pilates_class.id, request_type: 'alert' },
                        method: :post,
                        class: "btn btn-primary",
                        style: "margin-top: 0.5rem;",
                        data: { turbo_frame: "_top" } %>
                  <% else %>
                    <p style="color: #e74c3c; font-size: 0.875rem; margin-top: 0.5rem;">
                      Nivel insuficiente
                    </p>
                  <% end %>
                </div>
              <% end %>
            <% else %>
              <p style="color: #999; font-style: italic;">No hay clases en este horario</p>
            <% end %>
          </div>
        <% end %>
      <% else %>
        <p>No hay clases disponibles para esta fecha</p>
      <% end %>
    </div>
  <% end %>
</div>
