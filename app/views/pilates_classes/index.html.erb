<div class="agenda-page">
  <h1>Ver Agenda</h1>

  <!-- Navegación Semanal -->
  <div class="calendar-navigation">
    <%= link_to agenda_path(date: (@week_start - 7.days).to_s), class: "btn btn-outline", data: { turbo_frame: "calendar" } do %>
      ← Semana Anterior
    <% end %>
    
    <div class="week-display">
      <h2>
        <%= I18n.l(@week_start, format: "%d de %B") %> - 
        <%= I18n.l(@week_end, format: "%d de %B de %Y") %>
      </h2>
    </div>
    
    <%= link_to agenda_path(date: (@week_start + 7.days).to_s), class: "btn btn-outline", data: { turbo_frame: "calendar" } do %>
      Semana Siguiente →
    <% end %>
  </div>

  <!-- Calendario Semanal con Turbo Frame -->
  <%= turbo_frame_tag "calendar" do %>
    <div class="calendar-week-container">
      <% (@week_start..@week_end).each do |day| %>
        <% day_classes = @classes_by_day[day] || [] %>
        <div class="calendar-day">
          <div class="day-header">
            <strong><%= I18n.l(day, format: "%A %d") %></strong>
            <span class="day-classes-count"><%= day_classes.count %> clase<%= 's' if day_classes.count != 1 %></span>
          </div>
          
          <% if day_classes.any? %>
            <% day_classes.group_by { |c| c.start_time.hour }.each do |hour, classes_at_hour| %>
              <div class="hour-block">
                <div class="hour-label"><%= hour %>:00</div>
                <% classes_at_hour.each do |pilates_class| %>
                  <div class="class-item <%= 'full' if pilates_class.full? %>">
                    <div class="class-info">
                      <strong><%= pilates_class.name %></strong>
                      <p class="class-details">
                        <%= pilates_class.room.name %>
                      </p>
                      <p class="class-time">
                        <%= pilates_class.start_time.strftime("%H:%M") %> - 
                        <%= pilates_class.end_time.strftime("%H:%M") %>
                      </p>
                      <p class="class-level">
                        Nivel: <strong><%= pilates_class.level.humanize %></strong>
                      </p>
                    </div>
                    <div class="class-availability"></div>
                    
                    <% if current_user.can_reserve_class?(pilates_class) && !pilates_class.full? %>
                      <%= button_to "Reservar (1 crédito)", reservations_path, 
                          params: { pilates_class_id: pilates_class.id },
                          method: :post,
                          class: "btn btn-success btn-reserve",
                          data: { turbo_frame: "_top" } %>
                    <% elsif pilates_class.full? %>
                      <%= button_to "Notificarme", requests_path, 
                          params: { pilates_class_id: pilates_class.id, request_type: 'alert' },
                          method: :post,
                          class: "btn btn-primary btn-reserve",
                          data: { turbo_frame: "_top" } %>
                    <% else %>
                      <p class="cannot-reserve">Nivel insuficiente</p>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="no-classes">No hay clases este día</p>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
