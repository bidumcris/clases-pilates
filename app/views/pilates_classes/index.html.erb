<div class="agenda-page" data-controller="recupero-confirm">
  <h1>Ver Agenda</h1>

  <!-- Semana actual (recuperos) -->
  <div class="calendar-navigation">
    <div class="week-display" style="width: 100%; text-align: center;">
      <h2 style="margin: 0;">
        <%= I18n.l(@week_start, format: "%d de %B") %> -
        <%= I18n.l(@week_end, format: "%d de %B de %Y") %>
      </h2>
      <p style="margin: .35rem 0 0 0; opacity: .75;">
        Solo podés ver y reservar clases de la semana actual.
      </p>
      <% if !current_user.can_use_recupero? && current_user.credits.available_this_month.any? %>
        <p class="agenda-payment-pending-banner" role="alert">
          Pago pendiente. Después del 10 no podés reservar con recupero sin estar al día con el pago.
        </p>
      <% end %>
    </div>
  </div>

  <!-- Calendario Semanal con Turbo Frame -->
  <%= turbo_frame_tag "calendar" do %>
    <div class="calendar-week-container">
      <% (@week_start..@week_end).each do |day| %>
        <% day_classes = @classes_by_day[day] || [] %>
        <div class="calendar-day">
          <div class="day-header">
            <strong><%= I18n.l(day, format: "%A %d") %></strong>
            <span class="day-classes-count"><%= day_classes.count %> clase<%= 's' if day_classes.count != 1 %></span>
          </div>
          
          <% if day_classes.any? %>
            <% day_classes.group_by { |c| c.start_time.hour }.each do |hour, classes_at_hour| %>
              <div class="hour-block">
                <div class="hour-label"><%= hour %>:00</div>
                <% classes_at_hour.each do |pilates_class| %>
                  <div class="class-item <%= 'full' if pilates_class.full? %>">
                    <div class="class-info">
                      <strong><%= pilates_class.name %></strong>
                      <p class="class-details">
                        <%= pilates_class.room.name %>
                      </p>
                      <p class="class-time">
                        <%= pilates_class.start_time.strftime("%H:%M") %>
                      </p>
                      <div class="class-availability">
                        <p class="spots-info">
                          Quedan <%= pilates_class.available_spots %> lugar<%= 'es' if pilates_class.available_spots != 1 %>
                        </p>
                      </div>
                      <p class="class-level">
                        Nivel: <strong><%= level_label(pilates_class.level) %></strong>
                      </p>
                    </div>
                    
                    <% if current_user.can_reserve_class?(pilates_class) && !pilates_class.full? && pilates_class.reservable_now? %>
                      <% if current_user.can_use_recupero? && current_user.credit_available_for_recupero(pilates_class) %>
                        <button type="button"
                                class="btn btn-success btn-reserve"
                                data-action="click->recupero-confirm#open"
                                data-recupero-confirm-pilates-class-id-param="<%= pilates_class.id %>">
                          Reservar (1 recupero)
                        </button>
                      <% elsif !current_user.can_use_recupero? %>
                        <p class="cannot-reserve payment-pending-msg">Pago pendiente. No podés reservar con recupero después del 10 sin estar al día.</p>
                      <% elsif !current_user.credit_available_for_recupero(pilates_class) %>
                        <p class="cannot-reserve">No tenés recupero disponible para esta clase.</p>
                      <% end %>
                    <% elsif current_user.can_reserve_class?(pilates_class) && !pilates_class.full? && !pilates_class.reservable_now? %>
                      <p class="cannot-reserve">Solo podés reservar hasta <%= Setting.get("accion_minprevturno").presence || "0" %> min antes del inicio</p>
                    <% elsif pilates_class.full? %>
                      <%= button_to requests_path,
                          params: { pilates_class_id: pilates_class.id, request_type: 'alert' },
                          method: :post,
                          class: "btn btn-primary btn-reserve btn-notify",
                          data: { turbo_frame: "_top" } do %>
                        <span class="btn-icon" aria-hidden="true">
                          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2Z" fill="currentColor"/>
                            <path d="M18 16v-5c0-3.07-1.63-5.64-4.5-6.32V4a1.5 1.5 0 0 0-3 0v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2Z" fill="currentColor"/>
                          </svg>
                        </span>
                        <span>Notificarme</span>
                      <% end %>
                    <% else %>
                      <p class="cannot-reserve">Nivel insuficiente</p>
                    <% end %>
                  </div>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="no-classes">No hay clases este día</p>
          <% end %>
        </div>
      <% end %>
    </div>
  <% end %>

  <!-- Modal confirmación recupero -->
  <div id="recupero-confirm-modal"
       class="recupero-confirm-modal"
       data-recupero-confirm-target="modal"
       aria-hidden="true"
       role="dialog"
       aria-modal="true"
       aria-labelledby="recupero-confirm-title">
    <div class="recupero-confirm-modal-backdrop" data-action="click->recupero-confirm#close"></div>
    <div class="recupero-confirm-modal-dialog">
      <div class="recupero-confirm-modal-content">
        <h2 id="recupero-confirm-title" class="recupero-confirm-modal-title">Reservar con recupero</h2>
        <p class="recupero-confirm-modal-text">
          El recupero una vez pactado día y hora no tiene modificaciones.
        </p>
        <p class="recupero-confirm-modal-text"><strong>¿Confirmás?</strong></p>
        <%= form_with url: reservations_path, method: :post, local: true, data: { turbo_frame: "_top" }, class: "recupero-confirm-form" do |f| %>
          <%= f.hidden_field :pilates_class_id, value: "", data: { recupero_confirm_target: "pilatesClassIdInput" } %>
          <div class="recupero-confirm-modal-actions">
            <button type="button" class="btn btn-outline-secondary" data-action="click->recupero-confirm#close">Cancelar</button>
            <%= f.submit "Confirma", class: "btn btn-success" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
