<div class="admin-form-page">
  <div class="admin-page-header">
    <h1>Nuevo alumno</h1>
    <%= link_to "Volver", management_students_path, class: "btn btn-outline" %>
  </div>

  <div class="form-container">
    <%= form_with model: @user, url: management_students_path, scope: :user, local: true, class: "admin-form" do |f| %>
      <%= render "shared/error_messages", resource: @user %>

      <div class="admin-section">
        <h2>Datos personales</h2>

        <div class="form-row form-row--cols-3">
          <div class="form-group">
            <label for="user_first_name">Nombre</label>
            <%= text_field_tag "user[first_name]", nil, class: "form-control", placeholder: "Ej: Ana" %>
          </div>
          <div class="form-group">
            <label for="user_last_name">Apellido</label>
            <%= text_field_tag "user[last_name]", nil, class: "form-control", placeholder: "Ej: Pérez" %>
          </div>
          <div class="form-group">
            <%= f.label :dni, "DNI o CI" %>
            <%= f.text_field :dni, class: "form-control" %>
          </div>
        </div>

        <div class="form-row form-row--cols-3">
          <div class="form-group">
            <%= f.label :email, "Email (*)" %>
            <%= f.email_field :email, class: "form-control", placeholder: "ana@..." %>
          </div>
          <div class="form-group">
            <%= f.label :mobile, "Teléfono celular" %>
            <%= f.text_field :mobile, class: "form-control", placeholder: "+54 ..." %>
          </div>
          <div class="form-group">
            <%= f.label :emergency_phone, "Teléfono de contacto (para emergencias)" %>
            <%= f.text_field :emergency_phone, class: "form-control" %>
          </div>
        </div>

        <div class="form-row form-row--cols-3">
          <div class="form-group">
            <%= f.label :birth_date, "Fecha de nacimiento" %>
            <%= f.date_field :birth_date, class: "form-control" %>
          </div>
          <div class="form-group">
            <%= f.label :join_date, "Fecha de ingreso" %>
            <%= f.date_field :join_date, class: "form-control" %>
          </div>
          <div class="form-group">
            <%= f.label :password, "Contraseña" %>
            <div style="display:flex; gap:0.75rem; flex-direction:column;">
              <%= f.password_field :password, class: "form-control", placeholder: "Contraseña" %>
              <%= f.password_field :password_confirmation, class: "form-control", placeholder: "Confirmar contraseña" %>
            </div>
          </div>
        </div>
      </div>

      <div class="admin-section" style="margin-top: 1.5rem;">
        <h2>Datos de suscripción (para Circuito - Planta Alta)</h2>

        <!--
        <div class="form-row">
          <div class="form-group">
            <%= f.label :level, "Nivel" %>
            <%= f.select :level, options_for_select(User.levels.keys.map { |k| [k.humanize, k] }, @user.level), {}, { class: "form-control" } %>
          </div>
          <div class="form-group">
            <%= f.label :class_type, "Tipo de clase" %>
            <%= f.select :class_type, options_for_select(User.class_types.keys.map { |k| [k.humanize, k] }, @user.class_type), {}, { class: "form-control" } %>
          </div>
          <div class="form-group">
            <%= f.label :active, "Activo" %><br>
            <%= f.check_box :active %>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <%= f.label :subscription_start, "Alta del servicio" %>
            <%= f.date_field :subscription_start, class: "form-control" %>
            <small class="form-hint">Si el alumno entra a mitad de mes, poné esta fecha.</small>
          </div>
          <div class="form-group">
            <%= f.label :subscription_end, "Fin del servicio (mes)" %>
            <%= f.date_field :subscription_end, class: "form-control" %>
            <small class="form-hint">Normalmente es el último día del mes.</small>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <%= f.label :monthly_turns, "Turnos del mes (plan)" %>
            <%= f.number_field :monthly_turns, class: "form-control", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :payment_amount, "Importe mensual" %>
            <%= f.number_field :payment_amount, class: "form-control", step: "0.01", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :debt_amount, "Deuda" %>
            <%= f.number_field :debt_amount, class: "form-control", step: "0.01", min: 0 %>
          </div>
        </div>
        -->

        <div class="form-row">
          <div class="form-group">
            <%= f.label :additional_info, "Etiqueta del alumno (privada, no podrá verla el alumno)" %>
            <%= f.text_field :additional_info, class: "form-control", placeholder: "Ej: Embarazada, recupero de lesión, etc." %>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Usar días fijos</label>
            <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
              <label style="display:flex; align-items:center; gap:0.35rem;">
                <input type="radio" name="use_fixed_days" value="no" checked>
                <span>No</span>
              </label>
              <label style="display:flex; align-items:center; gap:0.35rem;">
                <input type="radio" name="use_fixed_days" value="si">
                <span>Sí</span>
              </label>
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tipo de clase</label>
            <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
              <label style="display:flex; align-items:center; gap:0.35rem;">
                <%= f.radio_button :class_type, "grupal", id: "user_class_type_grupal" %>
                <span>Clase grupal</span>
              </label>
              <label style="display:flex; align-items:center; gap:0.35rem;">
                <%= f.radio_button :class_type, "privada", id: "user_class_type_privada" %>
                <span>Clase personalizada</span>
              </label>
            </div>
          </div>
        </div>

        <% day_options = User::WEEKDAY_OPTIONS %>
        <% room_schedules = {} %>
        <% @rooms.each do |room| %>
          <% next if room.service_schedule_description.blank? %>
          <% schedule_map = {} %>
          <% raw_lines = room.service_schedule_description.to_s.split(/\r?\n/) %>
          <% raw_lines.each do |line| %>
            <% line = line.to_s.strip %>
            <% next if line.blank? %>
            <% day_name, times_str = line.split(/\s+/, 2) %>
            <% day_name = day_name.to_s.strip %>
            <% day_num = { "Lunes" => 1, "Martes" => 2, "Miércoles" => 3, "Miercoles" => 3, "Jueves" => 4, "Viernes" => 5 }[day_name] %>
            <% next unless day_num && times_str.present? %>
            <% hours =
              times_str.split(/[,，]/).map { |t| t.to_s.strip.sub(/:00\z/, "") }.map(&:to_i)
                       .select { |h| h.between?(0, 23) }.uniq.sort %>
            <% schedule_map[day_num] = hours if hours.any? %>
          <% end %>
          <% room_schedules[room.id] = schedule_map if schedule_map.any? %>
        <% end %>

        <% level_options = User.levels.keys.map { |k| [k.to_s.humanize, k.to_s] } %>
        <% instructor_chooser_options = [["— Por defecto —", ""]] + @instructors.map { |i| [i.name, i.id] } %>

        <div class="form-row fixed-days-fields"
             data-fixed-days
             data-room-schedules="<%= room_schedules.to_json %>"
             style="display:none; margin-top:0.5rem;">
          <div class="form-group">
            <label>Sala</label>
            <%= select_tag "fixed_slot_room_chooser",
                  options_for_select([["— Ninguna —", ""]] + @rooms.map { |r| [r.admin_display_name, r.id] }),
                  class: "form-control",
                  data: { room_select: true } %>
          </div>
          <div class="form-group">
            <label>Día fijo</label>
            <%= select_tag "fixed_slot_day_chooser", options_for_select([["— Ninguno —", ""]] + day_options), class: "form-control" %>
          </div>
          <div class="form-group" style="min-width: 220px;">
            <label>Hora fija</label>
            <%= select_tag "fixed_slot_hour_chooser", options_for_select([["— Ninguna —", ""]]), class: "form-control", data: { hour_select: true } %>
            <div style="margin-top: 0.5rem; padding: 0.5rem 0; border-top: 1px solid #eee;">
              <label class="fixed-slot-inner-label">Nivel / tipo de sala</label>
              <%= select_tag "fixed_slot_level_chooser", options_for_select([["— Mismo del alumno —", ""]] + level_options), class: "form-control", style: "margin-bottom: 0.5rem;" %>
              <label class="fixed-slot-inner-label">Instructor</label>
              <%= select_tag "fixed_slot_instructor_chooser", options_for_select(instructor_chooser_options), class: "form-control" %>
            </div>
          </div>
        </div>

        <div id="fixed-slots-added" data-fixed-slots-container></div>

        <div class="form-row fixed-days-fields" data-fixed-days style="display:none; margin-top:0.75rem;">
          <div class="form-group">
            <button type="button" class="btn btn-success" data-action="add-fixed-slot">
              Agregar día fijo
            </button>
            <div id="fixed-slots-summary" class="form-hint" style="margin-top:0.5rem;"></div>
          </div>
        </div>

        <div style="margin-top: 1.5rem;">
          <button type="button" class="btn btn-primary btn-large btn-block margedvert" data-toggle-target="#subscription-extra-otros-datos">
            Editar otros datos de la suscripción <span class="caret"></span>
          </button>
          <div id="subscription-extra-otros-datos" style="display:none; margin-top: 0.75rem;">
            <div class="form-row form-row--cols-3">
              <div class="form-group">
                <label for="user_max_cancellations">
                  Cantidad máxima de cancelaciones
                  <small class="form-hint" style="display:block; font-weight:normal;">
                    Sólo completar si la cantidad es diferente a la que está configurada para la empresa en general.
                  </small>
                </label>
                <input
                  type="number"
                  min="0"
                  max="100"
                  name="turnosACancelar"
                  id="turnosACancelar"
                  class="form-control"
                  placeholder="[opcional] Valor de 0 a 100">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Bloquear autogestión a este usuario</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="block_self_management" value="no" checked>
                    <span>No</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="block_self_management" value="si">
                    <span>Sí</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row form-row--cols-3">
              <div class="form-group">
                <label for="franja1">Tiene Franja Horaria Oferta (1)</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="franja_oferta_1" value="si">
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="franja_oferta_1" value="no" checked>
                    <span>No</span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label for="franja2">Tiene Franja Horaria Oferta (2)</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="franja_oferta_2" value="si">
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="franja_oferta_2" value="no" checked>
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-primary btn-large btn-block margedvert" data-toggle-target="#subscription-extra-recordatorios">
            Editar Recordatorios <span class="caret"></span>
          </button>
          <div id="subscription-extra-recordatorios" style="display:none; margin-top: 0.75rem;">
            <div class="form-row form-row--cols-3">
              <div class="form-group">
                <label for="reminder_type_0">Tipo de recordatorio</label>
                <select id="reminder_type_0" name="reminders[0][type]" class="form-control">
                  <option value="">Selecciona el tipo</option>
                  <option value="general">General</option>
                  <option value="pago">Pago / Vencimiento</option>
                  <option value="cumpleanios">Cumpleaños</option>
                  <option value="otro">Otro</option>
                </select>
              </div>
              <div class="form-group">
                <label for="reminder_date_0">Fecha recordatorio (*)</label>
                <input
                  type="date"
                  id="reminder_date_0"
                  name="reminders[0][date]"
                  class="form-control">
              </div>
              <div class="form-group">
                <label>Dura el día completo</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="reminders[0][all_day]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="reminders[0][all_day]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="reminder_reason_0">Motivo recordatorio (*)</label>
                <input
                  type="text"
                  id="reminder_reason_0"
                  name="reminders[0][reason]"
                  class="form-control"
                  placeholder="Ej: Cobrar cuota, confirmar turno, etc.">
              </div>
            </div>

            <div style="margin-top: 0.75rem;">
              <button type="button" class="btn btn-outline-primary btn-sm">
                Agregar otro recordatorio
              </button>
            </div>
          </div>
          <button type="button" class="btn btn-primary btn-large btn-block margedvert" data-toggle-target="#subscription-extra-detallada">
            Editar información detallada <span class="caret"></span>
          </button>
          <div id="subscription-extra-detallada" style="display:none; margin-top: 0.75rem;">
            <div class="form-row">
              <div class="form-group">
                <label for="inputtags">Etiquetas (tags)</label>
                <textarea
                  name="tags"
                  id="inputtags"
                  class="form-control"
                  placeholder="Ingresa los tags separados por coma"></textarea>
              </div>
            </div>

            <div class="form-row form-row--cols-3">
              <div class="form-group">
                <%= f.label :join_date, "Fecha de ingreso" %>
                <%= f.date_field :join_date, class: "form-control" %>
              </div>
              <div class="form-group">
                <label for="inputnumSocio">Número de socio</label>
                <input
                  type="text"
                  name="numSocio"
                  id="inputnumSocio"
                  class="form-control"
                  placeholder="Ingresa el número de ficha">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="inputreferidoPor">Referido por</label>
                <textarea
                  name="referidoPor"
                  id="inputreferidoPor"
                  class="form-control"
                  placeholder="Ingresa el medio por el que llegó a tu empresa"></textarea>
              </div>
            </div>
          </div>

          <button type="button" class="btn btn-primary btn-large btn-block margedvert" data-toggle-target="#subscription-extra-alertas">
            Configurar alertas por email <span class="caret"></span>
          </button>
          <div id="subscription-extra-alertas" style="display:none; margin-top: 0.75rem;">
            <div class="form-row">
              <div class="form-group">
                <label for="email_alert_free_reminder">Configuración de alertas por email</label>
                <small class="form-hint" style="display:block; margin-top:0.25rem;">
                  Recordatorio turnos libres/recuperatorios:
                </small>
                <select id="email_alert_free_reminder" name="email_alerts[free_slots_reminder]" class="form-control" style="margin-top:0.35rem;">
                  <option value="">Selecciona el tipo</option>
                  <option value="day_before_and_hours_before" selected>Dia anterior y horas antes</option>
                  <option value="only_day_before">Sólo día anterior</option>
                  <option value="only_hours_before">Sólo horas antes</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Aviso por asistir al turno</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_attendance]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_attendance]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Aviso por inasistencia</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_absence]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_absence]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Recordatorio previo de asistencia a turno</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[pre_attendance]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[pre_attendance]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Aviso por anular un turno</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_cancel]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_cancel]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Aviso por realizar un pago y recibir solicitudes de pago, cancelar y/o finalizar un pago</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_payment_flow]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_payment_flow]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Aviso por recordatorio de pago</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem%;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_payment_reminder]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[on_payment_reminder]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Notificaciones importantes (activación de cuenta, cambio de contraseña, cumpleaños, suscripción finalizada, exclusiones días/horarios, etc.)</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[important_notifications]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[important_notifications]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label>Mensajes directos (mensajería)</label>
                <div style="display:flex; gap:1rem; align-items:center; margin-top:0.5rem;">
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[direct_messages]" value="si" checked>
                    <span>Sí</span>
                  </label>
                  <label style="display:flex; align-items:center; gap:0.35rem;">
                    <input type="radio" name="email_alerts[direct_messages]" value="no">
                    <span>No</span>
                  </label>
                </div>
              </div>
            </div>

            <div style="margin-top: 1rem;">
              <button type="submit" class="btn btn-primary btn-large">
                Guardar y volver
              </button>
            </div>
          </div>
        </div>
      </div>

      <!--
      <div class="admin-section" style="margin-top: 1.5rem;">
        <h2>Salas y horarios (turnos fijos)</h2>
        <p class="form-hint">Opcional. Podés asignar hasta 6 turnos fijos: cada uno con sala, día y hora (y opcionalmente instructor). Un alumno puede tener varias salas con distintos horarios.</p>
        <% room_options = [["— Ninguna —", ""]] + @rooms.map { |r| [r.admin_display_name, r.id] } %>
        <% instructor_options = [["— Por defecto —", ""]] + @instructors.map { |i| [i.name, i.id] } %>
        <% day_options_full = [["— Ninguno —", ""]] + User::WEEKDAY_OPTIONS %>
        <% hour_options_full = [["— Ninguna —", ""]] + (7..20).map { |h| ["#{h}:00", h] } %>
        <% 6.times do |idx| %>
          <div class="fixed-slot-row" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
            <div class="form-group" style="margin: 0; min-width: 180px;">
              <label class="fixed-slot-row-label">Turno <%= idx + 1 %> — Sala</label>
              <%= select_tag "fixed_slot_room_id[]", options_for_select(room_options, nil), class: "form-control" %>
            </div>
            <div class="form-group" style="margin: 0; min-width: 160px;">
              <label class="fixed-slot-row-label">Instructor</label>
              <%= select_tag "fixed_slot_instructor_id[]", options_for_select(instructor_options, nil), class: "form-control" %>
            </div>
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label class="fixed-slot-row-label">Día</label>
              <%= select_tag "fixed_slot_day_of_week[]", options_for_select(day_options_full, nil), class: "form-control" %>
            </div>
            <div class="form-group" style="margin: 0; min-width: 100px;">
              <label class="fixed-slot-row-label">Hora</label>
              <%= select_tag "fixed_slot_hour[]", options_for_select(hour_options_full, nil), class: "form-control" %>
            </div>
          </div>
        <% end %>
      </div>
      -->

      <div class="form-actions">
        <%= f.submit "Guardar y volver", class: "btn btn-primary btn-large" %>
        <%= link_to "Cancelar", management_students_path, class: "btn btn-outline" %>
      </div>
    <% end %>
  </div>
</div>
<script>
  (function() {
    function initStudentNewToggles() {
      // Evitar inicializar dos veces (por DOMContentLoaded + turbo:load)
      if (document.documentElement.dataset.studentNewTogglesInitialized === "1") return;
      document.documentElement.dataset.studentNewTogglesInitialized = "1";

      // Toggle campos de días fijos + horarios dinámicos según sala seleccionada
      var radios = document.querySelectorAll('input[name="use_fixed_days"]');
      var fixedFieldGroups = document.querySelectorAll('[data-fixed-days]');
      if (radios.length && fixedFieldGroups.length) {
        radios.forEach(function(radio) {
          radio.addEventListener("change", function() {
            if (this.value === "si") {
              fixedFieldGroups.forEach(function(g) { g.style.display = ""; });
            } else {
              fixedFieldGroups.forEach(function(g) { g.style.display = "none"; });
            }
          });
        });

        // Horarios por día por sala: viene en data-room-schedules como
        // { "22": { "1":[17,18], "2":[17,18,21] }, "23": { ... } }
        var fixedFields = fixedFieldGroups[0]; // primer grupo: contiene room_schedules
        var roomSchedulesRaw = fixedFields.getAttribute('data-room-schedules') || '{}';
        var roomSchedules = {};
        try { roomSchedules = JSON.parse(roomSchedulesRaw); } catch(e) { roomSchedules = {}; }

        var roomSelect = fixedFields.querySelector('select[data-room-select]');
        var daySelect  = fixedFields.querySelector('select[name="fixed_slot_day_chooser"]');
        var hourSelect = fixedFields.querySelector('select[name="fixed_slot_hour_chooser"]');
        var currentSchedule = {};

        function rebuildHourOptions() {
          if (!daySelect || !hourSelect) return;
          var selectedDay = daySelect.value; // "1".."5" o ""

          // Limpiar opciones actuales
          while (hourSelect.firstChild) hourSelect.removeChild(hourSelect.firstChild);

          // Siempre agregar opción "Ninguna"
          var optNone = document.createElement('option');
          optNone.value = '';
          optNone.textContent = '— Ninguna —';
          hourSelect.appendChild(optNone);

          if (!selectedDay || !currentSchedule[selectedDay]) return;

          currentSchedule[selectedDay].forEach(function(h) {
            var opt = document.createElement('option');
            opt.value = String(h);
            opt.textContent = h + ':00';
            hourSelect.appendChild(opt);
          });
        }

        function updateScheduleForRoom() {
          if (!roomSelect) return;
          var roomId = roomSelect.value;
          currentSchedule = roomSchedules[roomId] || {};
          // Reset combinación día + hora cuando cambia la sala
          if (daySelect) {
            daySelect.value = '';
          }
          rebuildHourOptions();
        }

        if (roomSelect) {
          roomSelect.addEventListener('change', updateScheduleForRoom);
          // Inicializar en base a la sala seleccionada (si la hay)
          updateScheduleForRoom();
        }

        if (daySelect && hourSelect) {
          daySelect.addEventListener('change', rebuildHourOptions);
        }

        // Botón "Agregar día fijo": agrega el turno a la lista sin enviar el formulario
        var addBtn = document.querySelector('[data-action="add-fixed-slot"]');
        var container = document.getElementById('fixed-slots-added');
        var summaryEl = document.getElementById('fixed-slots-summary');
        var levelChooser = fixedFields.querySelector('select[name="fixed_slot_level_chooser"]');
        var instructorChooser = fixedFields.querySelector('select[name="fixed_slot_instructor_chooser"]');
        var dayLabels = { '1': 'Lunes', '2': 'Martes', '3': 'Miércoles', '4': 'Jueves', '5': 'Viernes' };

        if (addBtn && container) {
          addBtn.addEventListener('click', function() {
            var roomId = roomSelect ? roomSelect.value : '';
            var day = daySelect ? daySelect.value : '';
            var hour = hourSelect ? hourSelect.value : '';
            if (!roomId || !day || !hour) {
              alert('Elegí sala, día y hora antes de agregar el día fijo.');
              return;
            }
            var levelVal = levelChooser ? levelChooser.value : '';
            var instructorVal = instructorChooser ? instructorChooser.value : '';
            var hourLabel = hour + ':00';

            var wrap = document.createElement('div');
            wrap.setAttribute('data-fixed-slot-row', '');
            wrap.innerHTML =
              '<input type="hidden" name="fixed_slot_room_id[]" value="' + roomId + '">' +
              '<input type="hidden" name="fixed_slot_day_of_week[]" value="' + day + '">' +
              '<input type="hidden" name="fixed_slot_hour[]" value="' + hour + '">' +
              '<input type="hidden" name="fixed_slot_level[]" value="' + levelVal + '">' +
              '<input type="hidden" name="fixed_slot_instructor_id[]" value="' + (instructorVal || '') + '">';
            container.appendChild(wrap);

            if (roomSelect) roomSelect.value = '';
            if (daySelect) daySelect.value = '';
            rebuildHourOptions();
            if (hourSelect) hourSelect.value = '';

            var count = container.querySelectorAll('[data-fixed-slot-row]').length;
            if (summaryEl) {
              summaryEl.textContent = count === 1
                ? '1 día fijo agregado: ' + (dayLabels[day] || day) + ' ' + hourLabel
                : count + ' días fijos agregados. Último: ' + (dayLabels[day] || day) + ' ' + hourLabel;
            }
          });
        }
      }

      // Toggle secciones de botones desplegables (otros datos, recordatorios, info detallada, alertas)
      document.querySelectorAll('[data-toggle-target]').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var targetSelector = btn.getAttribute('data-toggle-target');
          if (!targetSelector) { return; }
          var panel = document.querySelector(targetSelector);
          if (!panel) { return; }
          var isHidden = panel.style.display === 'none' || panel.style.display === '';
          panel.style.display = isHidden ? 'block' : 'none';
        });
      });
    }

    document.addEventListener("DOMContentLoaded", initStudentNewToggles);
    document.addEventListener("turbo:load", initStudentNewToggles);
  })();
</script>
