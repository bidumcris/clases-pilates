<div class="admin-form-page">
  <div class="admin-page-header">
    <h1>Nuevo alumno</h1>
    <%= link_to "Volver", management_students_path, class: "btn btn-outline" %>
  </div>

  <div class="form-container">
    <%= form_with model: @user, url: management_students_path, scope: :user, local: true, class: "admin-form" do |f| %>
      <%= render "shared/error_messages", resource: @user %>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :name, "Nombre y apellido" %>
          <%= f.text_field :name, class: "form-control", placeholder: "Ej: Ana Pérez" %>
        </div>
        <div class="form-group">
          <%= f.label :email, "Email" %>
          <%= f.email_field :email, class: "form-control", placeholder: "ana@..." %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :password, "Contraseña" %>
          <%= f.password_field :password, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= f.label :password_confirmation, "Confirmar contraseña" %>
          <%= f.password_field :password_confirmation, class: "form-control" %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :level, "Nivel" %>
          <%= f.select :level, options_for_select(User.levels.keys.map { |k| [k.humanize, k] }, @user.level), {}, { class: "form-control" } %>
        </div>
        <div class="form-group">
          <%= f.label :class_type, "Tipo de clase" %>
          <%= f.select :class_type, options_for_select(User.class_types.keys.map { |k| [k.humanize, k] }, @user.class_type), {}, { class: "form-control" } %>
        </div>
        <div class="form-group">
          <%= f.label :active, "Activo" %><br>
          <%= f.check_box :active %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :dni, "DNI" %>
          <%= f.text_field :dni, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= f.label :mobile, "Celular" %>
          <%= f.text_field :mobile, class: "form-control", placeholder: "+54 ..." %>
        </div>
        <div class="form-group">
          <%= f.label :phone, "Teléfono" %>
          <%= f.text_field :phone, class: "form-control" %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :birth_date, "Fecha de nacimiento" %>
          <%= f.date_field :birth_date, class: "form-control" %>
        </div>
        <div class="form-group">
          <%= f.label :join_date, "Fecha de ingreso" %>
          <%= f.date_field :join_date, class: "form-control" %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :subscription_start, "Alta del servicio" %>
          <%= f.date_field :subscription_start, class: "form-control" %>
          <small class="form-hint">Si el alumno entra a mitad de mes, poné esta fecha.</small>
        </div>
        <div class="form-group">
          <%= f.label :subscription_end, "Fin del servicio (mes)" %>
          <%= f.date_field :subscription_end, class: "form-control" %>
          <small class="form-hint">Normalmente es el último día del mes.</small>
        </div>
      </div>

      <div class="admin-section" style="margin-top: 1.5rem;">
        <h2>Plan / Pagos (opcional)</h2>
        <div class="form-row">
          <div class="form-group">
            <%= f.label :monthly_turns, "Turnos del mes (plan)" %>
            <%= f.number_field :monthly_turns, class: "form-control", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :payment_amount, "Importe mensual" %>
            <%= f.number_field :payment_amount, class: "form-control", step: "0.01", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :debt_amount, "Deuda" %>
            <%= f.number_field :debt_amount, class: "form-control", step: "0.01", min: 0 %>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Días por semana</label>
            <div style="display:flex; gap:.75rem; flex-wrap: wrap; margin-top:.5rem;">
              <% User::WEEKDAY_OPTIONS.each do |label, value| %>
                <label style="display:flex; align-items:center; gap:.35rem;">
                  <%= f.check_box :weekly_days, { multiple: true }, value, nil %>
                  <span><%= label %></span>
                </label>
              <% end %>
            </div>
            <small class="form-hint">Ej: 2 veces/semana → Lunes y Miércoles. 3 veces/semana → Lunes, Miércoles y Viernes.</small>
          </div>
        </div>
      </div>

      <div class="admin-section" style="margin-top: 1.5rem;">
        <h2>Salas y horarios (turnos fijos)</h2>
        <p class="form-hint">Opcional. Podés asignar hasta 6 turnos fijos: cada uno con sala, día y hora (y opcionalmente instructor). Un alumno puede tener varias salas con distintos horarios.</p>
        <% room_options = [["— Ninguna —", ""]] + @rooms.map { |r| [r.admin_display_name, r.id] } %>
        <% instructor_options = [["— Por defecto —", ""]] + @instructors.map { |i| [i.name, i.id] } %>
        <% day_options = [["— Ninguno —", ""]] + User::WEEKDAY_OPTIONS %>
        <% hour_options = [["— Ninguna —", ""]] + (7..20).map { |h| ["#{h}:00", h] } %>
        <% 6.times do |idx| %>
          <div class="fixed-slot-row" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: end; margin-bottom: 0.75rem; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
            <div class="form-group" style="margin: 0; min-width: 180px;">
              <label class="fixed-slot-row-label">Turno <%= idx + 1 %> — Sala</label>
              <%= select_tag "fixed_slot_room_id[]", options_for_select(room_options, nil), class: "form-control" %>
            </div>
            <div class="form-group" style="margin: 0; min-width: 160px;">
              <label class="fixed-slot-row-label">Instructor</label>
              <%= select_tag "fixed_slot_instructor_id[]", options_for_select(instructor_options, nil), class: "form-control" %>
            </div>
            <div class="form-group" style="margin: 0; min-width: 120px;">
              <label class="fixed-slot-row-label">Día</label>
              <%= select_tag "fixed_slot_day_of_week[]", options_for_select(day_options, nil), class: "form-control" %>
            </div>
            <div class="form-group" style="margin: 0; min-width: 100px;">
              <label class="fixed-slot-row-label">Hora</label>
              <%= select_tag "fixed_slot_hour[]", options_for_select(hour_options, nil), class: "form-control" %>
            </div>
          </div>
        <% end %>
      </div>

      <div class="form-actions">
        <%= f.submit "Crear alumno", class: "btn btn-primary btn-large" %>
        <%= link_to "Cancelar", management_students_path, class: "btn btn-outline" %>
      </div>
    <% end %>
  </div>
</div>

