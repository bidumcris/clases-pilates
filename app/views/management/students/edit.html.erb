<div class="admin-form-page">
  <div class="admin-page-header">
    <h1>Editar alumno</h1>
    <%= link_to "Volver", management_student_path(@user), class: "btn btn-outline" %>
  </div>

  <div class="form-container">
    <%= form_with model: @user, url: management_student_path(@user), scope: :user, method: :patch, local: true, class: "admin-form" do |f| %>
      <%= render "shared/error_messages", resource: @user %>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :level, "Nivel" %>
          <%= f.select :level, options_for_select(User.levels.keys.map { |k| [k.humanize, k] }, @user.level), {}, { class: "form-control" } %>
        </div>

        <div class="form-group">
          <%= f.label :class_type, "Tipo de clase" %>
          <%= f.select :class_type, options_for_select(User.class_types.keys.map { |k| [k.humanize, k] }, @user.class_type), {}, { class: "form-control" } %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :name, "Nombre" %>
          <%= f.text_field :name, class: "form-control", placeholder: "Nombre y apellido" %>
        </div>
        <div class="form-group">
          <%= f.label :active, "Activo" %><br>
          <%= f.check_box :active %>
          <small class="form-hint">Si está inactivo, el alumno queda “baja” a nivel interno.</small>
        </div>
        <div class="form-group">
          <%= f.label :fake_email, "Email falso" %><br>
          <%= f.check_box :fake_email %>
          <small class="form-hint">Útil si no es un email real (para evitar envíos).</small>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :dni, "DNI" %>
          <%= f.text_field :dni, class: "form-control", placeholder: "Opcional (pero recomendado)" %>
        </div>

        <div class="form-group">
          <%= f.label :mobile, "Celular" %>
          <%= f.text_field :mobile, class: "form-control", placeholder: "+54 ..." %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :birth_date, "Fecha de nacimiento (opcional)" %>
          <%= f.date_field :birth_date, class: "form-control" %>
        </div>

        <div class="form-group">
          <%= f.label :phone, "Teléfono (opcional)" %>
          <%= f.text_field :phone, class: "form-control" %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :emergency_phone, "Tel. emergencia" %>
          <%= f.text_field :emergency_phone, class: "form-control", placeholder: "Contacto emergencia" %>
        </div>
        <div class="form-group">
          <%= f.label :additional_info, "Info adicional" %>
          <%= f.text_area :additional_info, class: "form-control", rows: 3, placeholder: "Alergias, lesiones, observaciones..." %>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <%= f.label :email, "Email" %>
          <%= f.email_field :email, class: "form-control" %>
        </div>
      </div>

      <div class="admin-section" style="margin-top: 1.5rem;">
        <h2>Abono / Pagos (administrativo)</h2>
        <div class="form-row">
          <div class="form-group">
            <%= f.label :subscription_start, "Abono inicio" %>
            <%= f.date_field :subscription_start, class: "form-control" %>
          </div>
          <div class="form-group">
            <%= f.label :subscription_end, "Abono fin" %>
            <%= f.date_field :subscription_end, class: "form-control" %>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <%= f.label :billing_status, "Pago" %>
            <%= f.select :billing_status,
              options_for_select(
                [
                  ["Abonado", "abonado"],
                  ["Pendiente", "pendiente"],
                  ["Deudor", "deudor"]
                ],
                @user.billing_status
              ),
              {},
              { class: "form-control" } %>
            <small class="form-hint">Esto es un estado manual para que el alumno lo vea en su dashboard.</small>
          </div>
          <div class="form-group">
            <%= f.label :payment_amount, "Importe pago" %>
            <%= f.number_field :payment_amount, class: "form-control", step: "0.01", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :debt_amount, "Importe deuda" %>
            <%= f.number_field :debt_amount, class: "form-control", step: "0.01", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :last_payment_date, "Fecha pago" %>
            <%= f.date_field :last_payment_date, class: "form-control" %>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <%= f.label :monthly_turns, "Turnos del mes (plan)" %>
            <%= f.number_field :monthly_turns, class: "form-control", min: 0 %>
          </div>
          <div class="form-group">
            <%= f.label :join_date, "Fecha ingreso" %>
            <%= f.date_field :join_date, class: "form-control" %>
          </div>
          <div class="form-group">
            <%= f.label :first_payment_date, "Fecha primer pago" %>
            <%= f.date_field :first_payment_date, class: "form-control" %>
          </div>
          <div class="form-group">
            <%= f.label :payments_count, "Cantidad pagos (manual)" %>
            <%= f.number_field :payments_count, class: "form-control", min: 0 %>
          </div>
        </div>
      </div>

      <details class="admin-section" style="margin-top: 1.5rem;">
        <summary style="cursor:pointer; font-weight:800;">Avanzado (opcional)</summary>
        <div class="card" style="margin-top: .75rem; padding: 1rem;">
          <p style="margin:0 0 .75rem 0; opacity:.75;">
            Solo si lo necesitás para compatibilidad/soporte.
          </p>
          <div class="form-row">
            <div class="form-group">
              <%= f.label :normal_view, "VistaNormal" %><br>
              <%= f.check_box :normal_view %>
            </div>
            <div class="form-group">
              <%= f.label :param1, "param1" %>
              <%= f.text_field :param1, class: "form-control" %>
            </div>
            <div class="form-group">
              <%= f.label :param2, "param2" %>
              <%= f.text_field :param2, class: "form-control" %>
            </div>
            <div class="form-group">
              <%= f.label :param3, "param3" %>
              <%= f.text_field :param3, class: "form-control" %>
            </div>
          </div>
        </div>
      </details>

      <div class="form-actions">
        <%= f.submit "Guardar", class: "btn btn-primary btn-large" %>
        <%= link_to "Cancelar", management_student_path(@user), class: "btn btn-outline" %>
      </div>
    <% end %>

    <%# IMPORTANTE: fuera del form para evitar forms anidados (button_to genera <form>) %>
    <% if current_user.admin? %>
      <div class="admin-section" style="margin-top: 1.5rem;">
        <h2>Recuperos (manual)</h2>
        <div class="card" style="padding: 1rem;">
          <p style="margin:0 0 .75rem 0;">
            Recuperos disponibles este mes: <strong><%= @user.credits.available_this_month.sum(:amount) %></strong>
            <span style="opacity:.8;">(máximo 3 por mes)</span>
          </p>
          <div style="display:flex; gap:.5rem; flex-wrap: wrap; align-items:center;">
            <span style="opacity:.8;">Sumar:</span>
            <% [1,2,3].each do |n| %>
              <%= button_to "+#{n}", grant_recoveries_management_student_path(@user, amount: n),
                method: :post,
                class: "btn btn-sm btn-primary",
                data: { turbo_confirm: "¿Otorgar +#{n} recupero(s) a #{@user.email}?" } %>
            <% end %>
            <span style="opacity:.8; margin-left:.25rem;">Quitar:</span>
            <% [1,2,3].each do |n| %>
              <%= button_to "-#{n}", deduct_recoveries_management_student_path(@user, amount: n),
                method: :post,
                class: "btn btn-sm btn-danger",
                data: { turbo_confirm: "¿Descontar -#{n} recupero(s) a #{@user.email}?" } %>
            <% end %>
          </div>
          <p style="margin:.75rem 0 0 0; opacity:.75;">
            Tip: estos recuperos se reinician cada mes.
          </p>
        </div>
      </div>
    <% end %>
  </div>
</div>


