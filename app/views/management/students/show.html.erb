<div class="admin-dashboard">
  <div class="admin-page-header" style="display:flex; gap: 1rem; align-items: center; justify-content: space-between;">
    <div>
      <h1 style="margin:0;">Ficha de alumno</h1>
      <p style="margin:.25rem 0 0 0; opacity:.8;"><%= @user.email %></p>
    </div>
    <div style="display:flex; gap:.5rem; flex-wrap: wrap;">
      <%= link_to "← Volver", management_students_path, class: "btn btn-outline" %>
      <% if current_user.admin? %>
        <%= link_to "Editar", edit_management_student_path(@user), class: "btn btn-primary" %>
      <% end %>
    </div>
  </div>

  <div class="admin-section">
    <h2>Datos</h2>
    <div class="card" style="margin-bottom: 1rem;">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; padding: 1rem;">
        <div><strong>Nombre:</strong> <%= @user.name.presence || "-" %></div>
        <div><strong>Activo:</strong> <%= @user.active? ? "Sí" : "No" %></div>
        <div><strong>Email falso:</strong> <%= @user.fake_email? ? "Sí" : "No" %></div>
        <div><strong>DNI:</strong> <%= @user.dni.presence || "-" %></div>
        <div><strong>Celular:</strong> <%= @user.mobile.presence || "-" %></div>
        <div><strong>Teléfono:</strong> <%= @user.phone.presence || "-" %></div>
        <div><strong>Tel. emergencia:</strong> <%= @user.emergency_phone.presence || "-" %></div>
        <div><strong>Fecha de nacimiento:</strong> <%= @user.birth_date ? @user.birth_date.strftime("%d/%m/%Y") : "-" %></div>
        <div><strong>Email:</strong> <%= @user.email %></div>
        <div><strong>Días fijos:</strong> <%= @user.fixed_days_summary.presence || "-" %></div>
        <div><strong>Info adicional:</strong> <%= @user.additional_info.presence || "-" %></div>
      </div>
    </div>
    <div class="admin-stats">
      <div class="stat-card">
        <div class="stat-number"><%= @user.level.humanize %></div>
        <div class="stat-label">Nivel</div>
      </div>
      <div class="stat-card">
        <div class="stat-number"><%= @user.class_type.humanize %></div>
        <div class="stat-label">Tipo</div>
      </div>
      <div class="stat-card">
        <div class="stat-number"><%= @user.credits_available %></div>
        <div class="stat-label">Créditos disponibles</div>
      </div>
      <div class="stat-card">
        <div class="stat-number"><%= @payments.select(&:completed?).sum(&:amount) %></div>
        <div class="stat-label">Pagos (completados)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number"><%= @user.turnos_consumidos_mes_actual %></div>
        <div class="stat-label">Turnos consumidos (mes)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number"><%= @user.monthly_turns.presence || "-" %></div>
        <div class="stat-label">Turnos del mes (plan)</div>
      </div>
      <div class="stat-card">
        <div class="stat-number"><%= @user.turnos_adeudados_mes_actual.presence || "-" %></div>
        <div class="stat-label">Turnos adeudados (mes)</div>
      </div>
    </div>
  </div>

  <div class="admin-section">
    <h2>Abono / Pagos (administrativo)</h2>
    <div class="card" style="margin-bottom: 1rem;">
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; padding: 1rem;">
        <div><strong>Abono inicio:</strong> <%= @user.subscription_start ? @user.subscription_start.strftime("%d/%m/%Y") : "-" %></div>
        <div><strong>Abono fin:</strong> <%= @user.subscription_end ? @user.subscription_end.strftime("%d/%m/%Y") : "-" %></div>
        <div><strong>Importe pago:</strong> <%= @user.payment_amount ? number_to_currency(@user.payment_amount, unit: "$", separator: ",", delimiter: ".") : "-" %></div>
        <div><strong>Importe deuda:</strong> <%= @user.debt_amount ? number_to_currency(@user.debt_amount, unit: "$", separator: ",", delimiter: ".") : "-" %></div>
        <div><strong>Fecha pago:</strong> <%= @user.last_payment_date ? @user.last_payment_date.strftime("%d/%m/%Y") : "-" %></div>
        <div><strong>Fecha ingreso:</strong> <%= @user.join_date ? @user.join_date.strftime("%d/%m/%Y") : "-" %></div>
        <div><strong>Fecha primer pago:</strong> <%= @user.first_payment_date ? @user.first_payment_date.strftime("%d/%m/%Y") : "-" %></div>
        <div><strong>Cantidad pagos (manual):</strong> <%= @user.payments_count.presence || "-" %></div>
        <div><strong>VistaNormal:</strong> <%= @user.normal_view? ? "Sí" : "No" %></div>
        <div><strong>param1:</strong> <%= @user.param1.presence || "-" %></div>
        <div><strong>param2:</strong> <%= @user.param2.presence || "-" %></div>
        <div><strong>param3:</strong> <%= @user.param3.presence || "-" %></div>
      </div>
    </div>
  </div>

  <div class="admin-section">
    <h2>Pagos</h2>
    <% if @payments.any? %>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Monto</th>
            <th>Método</th>
            <th>Estado</th>
            <th>Referencia</th>
          </tr>
        </thead>
        <tbody>
          <% @payments.each do |payment| %>
            <tr>
              <td><%= payment.created_at.strftime("%d/%m/%Y %H:%M") %></td>
              <td><%= number_to_currency(payment.amount, unit: "$", separator: ",", delimiter: ".") %></td>
              <td><%= payment.payment_method.humanize %></td>
              <td><%= payment.payment_status.humanize %></td>
              <td><%= payment.transaction_id.presence || "-" %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <p style="opacity:.7; margin-top:.5rem;">Tip: podés registrar pagos desde <%= link_to "Caja", management_cashbox_path %>.</p>
    <% else %>
      <p>No hay pagos registrados.</p>
    <% end %>
  </div>

  <div class="admin-section">
    <h2>Créditos</h2>
    <% if @credits.any? %>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Cantidad</th>
            <th>Expira</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          <% @credits.each do |credit| %>
            <tr>
              <td><%= credit.amount %></td>
              <td><%= credit.expires_at.strftime("%d/%m/%Y") %></td>
              <td>
                <% if credit.used? %>
                  Usado
                <% elsif credit.expired? %>
                  Expirado
                <% else %>
                  Disponible
                <% end %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% else %>
      <p>No hay créditos.</p>
    <% end %>
  </div>

  <div class="admin-section">
    <h2>Reservas recientes</h2>
    <% if @reservations.any? %>
      <table class="admin-table">
        <thead>
          <tr>
            <th>Clase</th>
            <th>Fecha</th>
            <th>Sala</th>
            <th>Instructor</th>
            <th>Estado</th>
            <th>Asistencia</th>
          </tr>
        </thead>
        <tbody>
          <% @reservations.each do |reservation| %>
            <tr>
              <td><%= reservation.pilates_class.name %></td>
              <td><%= reservation.pilates_class.start_time.strftime("%d/%m/%Y %H:%M") %></td>
              <td><%= reservation.pilates_class.room.name %></td>
              <td><%= reservation.pilates_class.instructor.name %></td>
              <td><%= reservation.status.humanize %></td>
              <td><%= reservation.attendance_status.humanize %></td>
            </tr>
          <% end %>
        </tbody>
      </table>
      <p style="opacity:.7; margin-top:.5rem;">La asistencia se marca desde “Tomar lista” en la clase.</p>
    <% else %>
      <p>No hay reservas.</p>
    <% end %>
  </div>
</div>


