<div class="admin-classes">
  <div class="admin-page-header">
    <h1>Gestión de Clases</h1>
    <% if current_user.admin? %>
      <%= link_to "Nueva Clase", new_management_class_path, class: "btn btn-primary" %>
      <%= link_to "Bloquear", block_management_classes_path, class: "btn btn-outline" %>
      <%= link_to "Panel Avanzado (ActiveAdmin)", admin_root_path, class: "btn btn-outline" %>
    <% end %>
  </div>

  <!-- Vista: Semana / Solo hoy -->
  <div class="admin-section" style="padding: 1rem;">
    <%= form_with url: management_classes_path, method: :get, local: true do %>
      <div style="display:flex; gap: .75rem; flex-wrap: wrap; align-items: end;">
        <div>
          <label>Vista</label><br>
          <%= select_tag :view,
            options_for_select([["Semana", "week"], ["Solo hoy", "today"]], @view_mode),
            class: "form-select" %>
        </div>

        <div>
          <label>Sala</label><br>
          <%= select_tag :room_id,
            options_for_select([["Todas", ""]] + @rooms.map { |r| [r.admin_display_name, r.id] }, @room_id.to_s),
            class: "form-select" %>
        </div>

        <%# En modo semana, permitimos elegir fecha de referencia %>
        <% if @view_mode == "week" %>
          <div>
            <label>Semana de</label><br>
            <%= date_field_tag :date, @date, class: "form-input" %>
          </div>
        <% end %>

        <div>
          <%= submit_tag "Ver", class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Navegación Semanal -->
  <div class="calendar-navigation">
    <% if @view_mode == "week" %>
      <%= link_to management_classes_path(date: (@week_start - 7.days).to_s, view: "week"), class: "btn btn-outline" do %>
        ← Semana Anterior
      <% end %>
    <% end %>
    
    <div class="week-display">
      <h2>
        <%= I18n.l(@week_start, format: "%d de %B") %> - 
        <%= I18n.l(@week_end, format: "%d de %B de %Y") %>
      </h2>
    </div>
    
    <% if @view_mode == "week" %>
      <%= link_to management_classes_path(date: (@week_start + 7.days).to_s, view: "week"), class: "btn btn-outline" do %>
        Semana Siguiente →
      <% end %>
    <% end %>
  </div>

  <!-- Calendario Semanal -->
  <div class="calendar-week-container">
    <% (@week_start..@week_end).each do |day| %>
      <% day_classes = @classes_by_day[day] || [] %>
      <div class="calendar-day admin-day">
        <div class="day-header">
          <strong><%= I18n.l(day, format: "%A %d") %></strong>
          <span class="day-classes-count"><%= day_classes.count %> clase<%= 's' if day_classes.count != 1 %></span>
        </div>
        
        <% if day_classes.any? %>
          <% day_classes.group_by { |c| c.start_time.hour }.each do |hour, classes_at_hour| %>
            <div class="hour-block">
              <div class="hour-label"><%= hour %>:00</div>
              <% classes_at_hour.each do |pilates_class| %>
                <div class="class-item admin-class-item">
                  <div class="class-info">
                    <strong><%= pilates_class.name %></strong>
                    <p class="class-details">
                      <%= pilates_class.room.name %> - <%= pilates_class.instructor.name %>
                    </p>
                    <% if pilates_class.holiday? %>
                      <p class="class-details" style="color:#8a4b5c;">
                        <strong>Feriado</strong><%= pilates_class.holiday_reason.present? ? ": #{pilates_class.holiday_reason}" : "" %>
                      </p>
                    <% end %>
                    <p class="class-time">
                      <%= pilates_class.start_time.strftime("%H:%M") %> - <%= pilates_class.end_time.strftime("%H:%M") %>
                    </p>
                    <p class="class-level">
                      Nivel: <strong><%= level_label(pilates_class.level) %></strong>
                      <span class="class-type-badge <%= pilates_class.privada? ? 'badge-warning' : 'badge-success' %>">
                        <%= pilates_class.class_type.humanize %>
                      </span>
                    </p>
                    <p class="class-capacity">
                      <%= pilates_class.available_spots %>/<%= pilates_class.max_capacity %> disponibles
                    </p>
                    <% booked = @booked_counts[pilates_class.id].to_i %>
                    <% if booked <= 2 %>
                      <p class="class-details" style="color:#8a4b5c;">
                        ⚠️ Solo <strong><%= booked %></strong> anotados
                      </p>
                    <% end %>
                  </div>
                  <div class="class-actions">
                    <%= link_to "Tomar lista", attendance_management_class_path(pilates_class), class: "btn btn-sm btn-outline" %>
                    <% if current_user.admin? %>
                      <% if pilates_class.holiday? %>
                        <%= button_to "Quitar feriado", unmark_holiday_management_class_path(pilates_class), method: :post,
                            class: "btn btn-sm btn-outline",
                            data: { turbo_confirm: "¿Quitar feriado de esta clase?" } %>
                      <% else %>
                        <%= button_to "Marcar feriado", mark_holiday_management_class_path(pilates_class), method: :post,
                            class: "btn btn-sm btn-outline",
                            params: { holiday_reason: "Feriado" },
                            data: { turbo_confirm: "¿Marcar esta clase como feriado? Se cancelarán reservas confirmadas y se otorgará 1 crédito compensatorio." } %>
                      <% end %>
                      <%= link_to "Editar", edit_management_class_path(pilates_class), class: "btn btn-sm btn-primary" %>
                      <%= button_to "Eliminar", management_class_path(pilates_class), method: :delete, 
                          class: "btn btn-sm btn-danger", 
                          data: { confirm: "¿Estás seguro de eliminar esta clase?" } %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="no-classes">No hay clases este día</p>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
