<div class="admin-classes">
  <div class="admin-page-header">
    <h1>Gestión de Clases</h1>
    <% if current_user.admin? %>
      <%= link_to "Nueva Clase", new_management_class_path, class: "btn btn-primary" %>
      <%= link_to "Bloquear", block_management_classes_path, class: "btn btn-outline" %>
      <%= link_to "Panel Avanzado (ActiveAdmin)", admin_root_path, class: "btn btn-outline" %>
    <% end %>
  </div>

  <!-- Vista: Semana / Solo hoy -->
  <div class="admin-section" style="padding: 1rem;">
    <%= form_with url: management_classes_path, method: :get, local: true do %>
      <div style="display:flex; gap: .75rem; flex-wrap: wrap; align-items: end;">
        <div>
          <label>Vista</label><br>
          <%= select_tag :view,
            options_for_select([["Semana", "week"], ["Solo hoy", "today"]], @view_mode),
            class: "form-select" %>
        </div>

        <div>
          <label>Sala</label><br>
          <%= select_tag :room_id,
            options_for_select([["Todas", ""]] + @rooms.map { |r| [r.admin_display_name, r.id] }, @room_id.to_s),
            class: "form-select" %>
        </div>

        <%# En modo semana, permitimos elegir fecha de referencia %>
        <% if @view_mode == "week" %>
          <div>
            <label>Semana de</label><br>
            <%= date_field_tag :date, @date, class: "form-input" %>
          </div>
        <% end %>

        <div>
          <%= submit_tag "Ver", class: "btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>

  <!-- Navegación Semanal -->
  <div class="calendar-navigation">
    <% if @view_mode == "week" %>
      <%= link_to management_classes_path(date: (@week_start - 7.days).to_s, view: "week"), class: "btn btn-outline" do %>
        ← Semana Anterior
      <% end %>
    <% end %>
    
    <div class="week-display">
      <h2>
        <%= I18n.l(@week_start, format: "%d de %B") %> - 
        <%= I18n.l(@week_end, format: "%d de %B de %Y") %>
      </h2>
    </div>
    
    <% if @view_mode == "week" %>
      <%= link_to management_classes_path(date: (@week_start + 7.days).to_s, view: "week"), class: "btn btn-outline" do %>
        Semana Siguiente →
      <% end %>
    <% end %>
  </div>

  <!-- Calendario Semanal -->
  <div class="calendar-week-container">
    <% (@week_start..@week_end).each do |day| %>
      <% day_classes = @classes_by_day[day] || [] %>
      <div class="calendar-day admin-day">
        <div class="day-header">
          <strong><%= I18n.l(day, format: "%A %d") %></strong>
          <span class="day-classes-count"><%= day_classes.count %> clase<%= 's' if day_classes.count != 1 %></span>
        </div>
        
        <% if day_classes.any? %>
          <% day_classes.group_by { |c| c.start_time.hour }.each do |hour, classes_at_hour| %>
            <div class="hour-block hour-block--compact">
              <div class="hour-label"><%= "%02d" % hour %></div>
              <% classes_at_hour.each do |pilates_class| %>
                <% occupied = pilates_class.max_capacity - pilates_class.available_spots %>
                <% percent = pilates_class.max_capacity.positive? ? (occupied.to_f / pilates_class.max_capacity * 100).round : 0 %>
                <div class="class-capacity-mini"
                     data-controller="class-modal"
                     data-class-modal-url-value="<%= modal_management_class_path(pilates_class) %>"
                     data-action="click->class-modal#open"
                     role="button"
                     tabindex="0"
                     aria-label="Ver clase <%= pilates_class.name %>">
                  <span class="class-capacity-mini-label"><%= pilates_class.privada? ? "Clase personalizada" : level_label(pilates_class.level) %></span>
                  <div class="class-capacity-progress class-capacity-progress--mini" role="progressbar" aria-valuenow="<%= occupied %>" aria-valuemin="0" aria-valuemax="<%= pilates_class.max_capacity %>">
                    <div class="class-capacity-progress-bar class-capacity-progress-bar--<%= percent >= 100 ? 'full' : (percent >= 75 ? 'warning' : 'ok') %>" style="width: <%= [percent, 100].min %>%;"></div>
                    <span class="class-capacity-progress-text"><%= occupied %>/<%= pilates_class.max_capacity %></span>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        <% else %>
          <p class="no-classes">No hay clases este día</p>
        <% end %>
      </div>
    <% end %>
  </div>

  <!-- Modal: detalle de clase al hacer clic en la barra -->
  <div id="class-modal" class="class-modal" data-controller="class-modal" data-class-modal-url-value="" aria-hidden="true">
    <div class="class-modal-backdrop" data-action="click->class-modal#close"></div>
    <div class="class-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="class-modal-title">
      <div class="class-modal-header">
        <h2 id="class-modal-title" class="class-modal-title">Clase</h2>
        <button type="button" class="class-modal-close" aria-label="Cerrar" data-action="click->class-modal#close">&times;</button>
      </div>
      <div class="class-modal-body" data-class-modal-target="body">
        <!-- Contenido cargado por JS -->
      </div>
    </div>
  </div>
</div>
