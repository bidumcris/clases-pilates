<% start = @pilates_class.start_time %>
<% modal_title = "Gestionar horario #{I18n.l(start, format: '%A')} #{start.day}/#{start.month} #{start.strftime('%H:%M')}hs" %>
<% frame_id = "class_modal_#{@pilates_class.id}" %>
<%= turbo_frame_tag frame_id do %>
<div data-modal-title="<%= modal_title %>" class="visually-hidden" aria-hidden="true"></div>

<div class="class-modal-card">
  <% if @class_in_future %>
    <%# Vista futura: botón con caret (completar después) %>
    <p class="class-modal-actions-top">
      <button type="button" class="btn btn-primary btn-block" data-action="click->#">
        Cambiar parámetros de esta clase <span class="caret"></span>
      </button>
    </p>
  <% else %>
    <%# Vista pasada: enlace a editar %>
    <p class="class-modal-actions-top">
      <%= link_to "Cambiar parámetros de esta clase", edit_management_class_path(@pilates_class), class: "btn btn-sm btn-outline" %>
    </p>
  <% end %>

  <div class="alert class-modal-alert-level <%= @class_in_future ? 'alert-danger' : 'alert-info' %>" role="alert">
    <span><strong>En este horario:</strong> <em><%= @pilates_class.privada? ? "Clase personalizada" : level_label(@pilates_class.level) %></em></span>
  </div>

  <div class="class-modal-buttons-row">
    <%= link_to "Nuevo turno", attendance_management_class_path(@pilates_class), class: "btn btn-sm btn-success" %>
    <%= link_to "Solicitudes", management_requests_path, class: "btn btn-sm btn-success" %>
  </div>
  <% if current_user.admin? %>
    <div class="class-modal-buttons-row">
      <% if @pilates_class.holiday? %>
        <%= button_to "Quitar bloqueo", unmark_holiday_management_class_path(@pilates_class), method: :post,
            class: "btn btn-sm btn-outline",
            data: { turbo_confirm: "¿Quitar feriado de esta clase?" } %>
      <% else %>
        <%= button_to "Bloquear horario", mark_holiday_management_class_path(@pilates_class), method: :post,
            class: "btn btn-sm btn-danger",
            params: { holiday_reason: "Feriado" },
            data: { turbo_confirm: "¿Marcar esta clase como feriado? Se cancelarán reservas confirmadas." } %>
      <% end %>
      <div data-controller="etiqueta-modal">
        <button type="button" class="btn btn-sm btn-warning" title="Etiqueta" data-action="click->etiqueta-modal#open">Etiqueta</button>
        <div data-etiqueta-modal-target="modal" class="etiqueta-modal" id="etiqueta-modal-inner" aria-hidden="true">
          <div class="etiqueta-modal-backdrop" data-action="click->etiqueta-modal#close"></div>
          <div class="etiqueta-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="etiqueta-modal-title">
            <div class="etiqueta-modal-header">
              <h3 id="etiqueta-modal-title" class="etiqueta-modal-title">Cambiar etiqueta y cupo</h3>
              <button type="button" class="etiqueta-modal-close" aria-label="Cerrar" data-action="click->etiqueta-modal#close">&times;</button>
            </div>
            <div class="etiqueta-modal-body">
              <%= form_with model: @pilates_class, url: management_class_path(@pilates_class), method: :patch,
                  data: { turbo_frame: frame_id }, class: "etiqueta-modal-form" do |f| %>
                <div class="form-group">
                  <%= f.label :level, "Nivel" %>
                  <%= f.select :level,
                      options_for_select([
                        [ "Inicial", "inicial" ],
                        [ "Basic", "basic" ],
                        [ "Intermedio", "intermediate" ],
                        [ "Pre avanzado", "advanced" ]
                      ], @pilates_class.level),
                      {},
                      { class: "form-control form-select" } %>
                </div>
                <div class="form-group">
                  <%= f.label :max_capacity, "Cupo máximo" %>
                  <%= f.number_field :max_capacity, min: 1, class: "form-control" %>
                </div>
                <div class="etiqueta-modal-actions">
                  <button type="button" class="btn btn-outline" data-action="click->etiqueta-modal#close">Cancelar</button>
                  <%= f.submit "Guardar", class: "btn btn-warning" %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </div>
  <% end %>

  <div class="class-modal-meta">
    <span class="label label-default">Cupo: <%= @pilates_class.max_capacity %></span>
    <%= link_to "Ver turnos del horario", attendance_management_class_path(@pilates_class), class: "class-modal-link-turnos" %>
  </div>

  <% if @class_in_future && @activos.present? %>
    <div class="class-modal-turnos-activos list-group-item">
      <strong>Turnos Activos</strong>
      <div class="class-modal-turnos-list">
        <% @activos.each_with_index do |reservation, idx| %>
          <div class="class-modal-turno-row">
            <%= button_to "[F#{idx + 1}] #{reservation.user.name} [#{level_label(reservation.user.level)}] ×",
                cancel_reservation_management_class_path(@pilates_class, reservation_id: reservation.id),
                method: :delete,
                class: "btn btn-sm btn-danger class-modal-turno-btn",
                data: { turbo_confirm: "¿Cancelar el turno de #{reservation.user.name}?" },
                form: { class: "class-modal-turno-form" } %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>

  <% if !@class_in_future && (@cancelados.present? || @atendidos.present?) %>
    <div class="class-modal-turnos-pasado">
      <% if @cancelados.present? %>
        <div class="class-modal-turnos-seccion">
          <strong>Turnos cancelados</strong>
          <ul class="class-modal-turnos-lista">
            <% @cancelados.each do |reservation| %>
              <li><%= reservation.user.name %> [<%= level_label(reservation.user.level) %>]</li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <% if @atendidos.present? %>
        <div class="class-modal-turnos-seccion">
          <strong>Turnos atendidos</strong>
          <ul class="class-modal-turnos-lista class-modal-turnos-lista--atendidos">
            <% @atendidos.each do |reservation| %>
              <li>
                <%= reservation.user.name %> [<%= level_label(reservation.user.level) %>]
                <span class="class-modal-attendance-badge class-modal-attendance-badge--<%= reservation.attendance_status %>">
                  <%= reservation.attendance_status == "presente" ? "Atendido" : reservation.attendance_status.humanize %>
                </span>
              </li>
            <% end %>
          </ul>
        </div>
      <% end %>
    </div>
  <% end %>
</div>
<% end %>
