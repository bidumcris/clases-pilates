<div class="admin-classes credits-page">
  <div class="admin-page-header credits-header">
    <div>
      <h1>Ver, agregar y quitar créditos</h1>
      <p class="admin-subtitle" style="margin: .25rem 0 0 0;">Buscá por email y operá rápido con acciones predefinidas.</p>
    </div>
    <%= link_to "Agregar crédito (manual)", new_management_credit_path, class: "btn btn-primary btn-large credits-cta" %>
  </div>

  <%= turbo_frame_tag "credits_panel" do %>
    <div class="admin-section">
      <h2>Buscar / Filtrar</h2>
      <%= form_with url: management_credits_path, method: :get, data: { turbo_frame: "credits_panel" }, class: "credits-filters", data: { controller: "autosubmit", autosubmit_delay_value: 250 } do %>
        <div class="credits-filters-grid">
          <div>
            <label>Alumno (email)</label><br>
            <%= text_field_tag :email, @email, class: "form-input", placeholder: "Escribí para filtrar…", data: { action: "input->autosubmit#queue" } %>
            <% if @email.present? && @student_matches.any? %>
              <div class="credits-suggestions">
                <% @student_matches.each do |student| %>
                  <%= link_to student.email, management_credits_path(email: student.email, used: params[:used], expired: params[:expired]),
                        data: { turbo_frame: "credits_panel" },
                        class: "credits-suggestion" %>
                <% end %>
              </div>
            <% end %>
          </div>
          <div>
            <label>Usado</label><br>
            <%= select_tag :used,
                options_for_select([["Todos", ""], ["No", "false"], ["Sí", "true"]], params[:used].to_s),
                class: "form-select",
                data: { action: "change->autosubmit#queue" } %>
          </div>
          <div class="credits-expired">
            <label>
              <%= check_box_tag :expired, "1", params[:expired] == "1", data: { action: "change->autosubmit#queue" } %>
              Solo expirados
            </label>
          </div>
          <div class="credits-apply">
            <%= submit_tag "Aplicar", class: "btn btn-outline-primary" %>
          </div>
        </div>
      <% end %>
    </div>

    <div class="admin-section">
      <h2>Panel rápido</h2>
      <% if @email.present? && @student_matches.any? %>
        <table class="admin-table credits-quick-table">
          <thead>
            <tr>
              <th>Alumno</th>
              <th>Créditos disponibles</th>
              <th>Otorgar</th>
              <th>Quitar</th>
            </tr>
          </thead>
          <tbody>
            <% @student_matches.each do |student| %>
              <tr>
                <td><%= link_to student.email, management_student_path(student), class: "link" %></td>
                <td><strong><%= student.credits.available.sum(:amount) %></strong></td>
                <td>
                  <div class="credits-actions-inline">
                    <% [1, 5, 10].each do |n| %>
                      <%= form_with url: grant_management_credits_path, method: :post, local: true do %>
                        <%= hidden_field_tag :email, student.email %>
                        <%= hidden_field_tag :amount, n %>
                        <%= hidden_field_tag :expires_at, Date.current.end_of_month.strftime("%Y-%m-%d") %>
                        <%= submit_tag "+#{n}", class: "btn btn-sm btn-primary" %>
                      <% end %>
                    <% end %>
                  </div>
                </td>
                <td>
                  <div class="credits-actions-inline">
                    <% [1, 5, 10].each do |n| %>
                      <%= form_with url: deduct_management_credits_path, method: :post, local: true do %>
                        <%= hidden_field_tag :email, student.email %>
                        <%= hidden_field_tag :amount, n %>
                        <%= submit_tag "-#{n}", class: "btn btn-sm btn-danger", data: { turbo_confirm: "¿Seguro que querés quitar #{n} crédito(s)?" } %>
                      <% end %>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
        <p class="credits-hint">Los botones rápidos usan vencimiento fin de mes. Para cargas especiales, usá “Agregar crédito (manual)”.</p>
      <% else %>
        <p class="credits-hint">Escribí el email exacto del alumno para habilitar acciones rápidas. Mientras tanto, abajo podés ver el historial filtrado.</p>
      <% end %>
    </div>

    <div class="admin-section">
      <h2>Historial</h2>
      <% if @credits.any? %>
        <table class="admin-table">
          <thead>
            <tr>
              <th>Alumno</th>
              <th>Cantidad</th>
              <th>Expira</th>
              <th>Estado</th>
              <th>Creado</th>
            </tr>
          </thead>
          <tbody>
            <% @credits.each do |credit| %>
              <tr>
                <td><%= link_to credit.user.email, management_student_path(credit.user), class: "link" %></td>
                <td><%= credit.amount %></td>
                <td><%= credit.expires_at.strftime("%d/%m/%Y") %></td>
                <td>
                  <% if credit.used? %>
                    Usado
                  <% elsif credit.expired? %>
                    Expirado
                  <% else %>
                    Disponible
                  <% end %>
                </td>
                <td><%= credit.created_at.strftime("%d/%m/%Y %H:%M") %></td>
              </tr>
            <% end %>
          </tbody>
        </table>
      <% else %>
        <p>No hay créditos para estos filtros.</p>
      <% end %>
    </div>
  <% end %>
</div>

